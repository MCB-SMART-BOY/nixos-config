#!/usr/bin/env bash
# Noctalia GPU specialisation switcher.

set -euo pipefail

# Ensure common system binaries are reachable when run via Noctalia.
export PATH="/run/wrappers/bin:/run/current-system/sw/bin:/etc/profiles/per-user/${USER}/bin:${HOME}/.nix-profile/bin:${HOME}/.local/bin:${PATH}"

MODE_DIR="/run/current-system/specialisation"

current_mode() {
  local path=""
  path="$(readlink -f /run/current-system 2>/dev/null || true)"
  if [[ -n "${path}" ]]; then
    if [[ "${path}" == */specialisation/* ]]; then
      local mode="${path##*/specialisation/}"
      mode="${mode%%/*}"
      if [[ -n "${mode}" ]]; then
        printf '%s' "${mode}"
        return 0
      fi
    fi
    if [[ "${path}" == *"specialisation-"* ]]; then
      local mode="${path##*specialisation-}"
      mode="${mode%%/*}"
      if [[ -n "${mode}" ]]; then
        printf '%s' "${mode}"
        return 0
      fi
    fi
  fi
  printf '%s' "base"
}

emit_status() {
  local mode=""
  local label=""
  mode="$(current_mode)"
  label="${mode}"
  if [[ "${label}" == gpu-* ]]; then
    label="${label#gpu-}"
  fi
  printf '{"text":"GPU:%s","tooltip":"GPU specialisation: %s"}\n' "${label}" "${mode}"
}

list_modes() {
  local modes=()
  if [[ -d "${MODE_DIR}" ]]; then
    while IFS= read -r -d '' entry; do
      local name=""
      name="$(basename "${entry}")"
      [[ "${name}" == gpu-* ]] || continue
      modes+=("${name}")
    done < <(find -L "${MODE_DIR}" -maxdepth 1 -mindepth 1 -type d -print0 2>/dev/null)
  fi

  printf '%s\n' "${modes[@]}"
}

pick_menu() {
  if command -v fuzzel >/dev/null 2>&1; then
    fuzzel --dmenu --prompt "GPU mode: "
  elif command -v wofi >/dev/null 2>&1; then
    wofi --dmenu -p "GPU mode"
  elif command -v rofi >/dev/null 2>&1; then
    rofi -dmenu -p "GPU mode"
  else
    return 2
  fi
}

build_rebuild_cmd() {
  local specialisation="$1"
  local cmd=(sudo nixos-rebuild switch)
  if [[ -n "${specialisation}" ]]; then
    cmd+=(--specialisation "${specialisation}")
  fi

  if [[ -f /etc/nixos/flake.nix ]]; then
    local host_name=""
    if [[ -f /etc/hostname ]]; then
      host_name="$(tr -d '\n' </etc/hostname)"
    elif command -v hostname >/dev/null 2>&1; then
      host_name="$(hostname)"
    fi
    if [[ -n "${host_name}" ]]; then
      cmd+=(--flake "/etc/nixos#${host_name}")
    else
      cmd+=(--flake "/etc/nixos")
    fi
  fi

  printf '%s\n' "${cmd[@]}"
}

launch_in_terminal() {
  local term=""
  local cmd=()
  term="${TERMINAL:-}"
  if [[ -z "${term}" ]]; then
    for candidate in alacritty foot kitty wezterm; do
      if command -v "${candidate}" >/dev/null 2>&1; then
        term="${candidate}"
        break
      fi
    done
  fi

  if [[ -z "${term}" ]]; then
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "GPU specialisation" "No terminal found to run nixos-rebuild"
    fi
    return 1
  fi

  cmd=("$@")
  if command -v niri-run >/dev/null 2>&1; then
    case "${term}" in
      wezterm)
        exec niri-run wezterm start -- "${cmd[@]}"
        ;;
      *)
        exec niri-run "${term}" -e "${cmd[@]}"
        ;;
    esac
  else
    case "${term}" in
      wezterm)
        exec wezterm start -- "${cmd[@]}"
        ;;
      *)
        exec "${term}" -e "${cmd[@]}"
        ;;
    esac
  fi
}

menu_flow() {
  local modes=()
  local labels=("base")
  local -A label_to_mode=()
  local mode=""
  local label=""
  local selection=""
  local target=""
  local menu_status=0

  mapfile -t modes < <(list_modes)
  for mode in "${modes[@]}"; do
    label="${mode#gpu-}"
    labels+=("${label}")
    label_to_mode["${label}"]="${mode}"
  done

  selection="$(printf '%s\n' "${labels[@]}" | pick_menu)"
  menu_status=$?
  if [[ "${menu_status}" -ne 0 ]]; then
    if [[ "${menu_status}" -eq 2 ]]; then
      # No GUI menu available; fall back to terminal selection
      local cmd_path=""
      cmd_path="$(command -v noctalia-gpu-mode || true)"
      if [[ -z "${cmd_path}" ]]; then
        cmd_path="$0"
      fi
      launch_in_terminal bash -lc "${cmd_path} --menu-cli"
    fi
    exit 0
  fi

  if [[ -z "${selection}" || "${selection}" == "cancel" ]]; then
    exit 0
  fi

  if [[ "${selection}" == "base" ]]; then
    target=""
  else
    target="${label_to_mode[${selection}]:-}"
    if [[ -z "${target}" ]]; then
      exit 0
    fi
  fi

  mapfile -t rebuild_cmd < <(build_rebuild_cmd "${target}")
  launch_in_terminal "${rebuild_cmd[@]}"
}

menu_flow_cli() {
  local modes=()
  local labels=("base")
  local -A label_to_mode=()
  local mode=""
  local label=""
  local selection=""
  local target=""

  mapfile -t modes < <(list_modes)
  for mode in "${modes[@]}"; do
    label="${mode#gpu-}"
    labels+=("${label}")
    label_to_mode["${label}"]="${mode}"
  done

  printf '%s\n' "Select GPU mode:"
  PS3="GPU mode: "
  select selection in "${labels[@]}"; do
    if [[ -n "${selection}" ]]; then
      break
    fi
  done

  if [[ -z "${selection}" || "${selection}" == "cancel" ]]; then
    exit 0
  fi

  if [[ "${selection}" == "base" ]]; then
    target=""
  else
    target="${label_to_mode[${selection}]:-}"
    if [[ -z "${target}" ]]; then
      exit 0
    fi
  fi

  mapfile -t rebuild_cmd < <(build_rebuild_cmd "${target}")
  printf 'Running: %s\n' "${rebuild_cmd[*]}"
  "${rebuild_cmd[@]}"
}

case "${1:-}" in
  --menu)
    menu_flow
    ;;
  --menu-cli)
    menu_flow_cli
    ;;
  *)
    emit_status
    ;;
esac
