#!/usr/bin/env bash
# Noctalia GPU specialisation switcher.

set -euo pipefail

# Ensure common system binaries are reachable when run via Noctalia.
export PATH="/run/wrappers/bin:/run/current-system/sw/bin:/etc/profiles/per-user/${USER:-}/bin:${HOME:-}/.nix-profile/bin:${HOME:-}/.local/bin:${PATH:-}"

MODE_DIR="/run/current-system/specialisation"
MODE_FILE_PATH=""

mode_file() {
  local config_home="${XDG_CONFIG_HOME:-${HOME:-}}"
  if [[ -z "${config_home}" ]]; then
    return 1
  fi
  printf '%s' "${config_home}/noctalia/gpu-modes"
}

normalize_mode() {
  local mode="$1"
  if [[ "${mode}" != gpu-* ]]; then
    mode="gpu-${mode}"
  fi
  printf '%s' "${mode}"
}

state_file() {
  local state_home="${XDG_STATE_HOME:-}"
  if [[ -z "${state_home}" ]]; then
    local home_dir="${HOME:-}"
    [[ -z "${home_dir}" ]] && return 1
    state_home="${home_dir}/.local/state"
  fi
  printf '%s' "${state_home}/noctalia/gpu-current"
}

boot_epoch() {
  local uptime=""
  local now=""
  if [[ -r /proc/uptime ]]; then
    read -r uptime _ </proc/uptime || return 1
    now="$(date +%s 2>/dev/null || true)"
    if [[ -n "${now}" && -n "${uptime}" ]]; then
      printf '%s' "$((now - ${uptime%.*}))"
      return 0
    fi
  fi
  return 1
}

read_state_mode() {
  local file=""
  local line=""
  file="$(state_file)" || return 1
  [[ -f "${file}" ]] || return 1
  read -r line < "${file}" || return 1
  line="${line%%#*}"
  line="${line//[[:space:]]/}"
  [[ -z "${line}" ]] && return 1
  if [[ "${line}" == "base" ]]; then
    printf '%s' "base"
  else
    normalize_mode "${line}"
  fi
}

read_state_mode_fresh() {
  local file=""
  local mode=""
  local boot_time=""
  local file_time=""
  file="$(state_file)" || return 1
  [[ -f "${file}" ]] || return 1
  boot_time="$(boot_epoch)" || boot_time=""
  if [[ -n "${boot_time}" ]]; then
    file_time="$(stat -c %Y "${file}" 2>/dev/null || true)"
    if [[ -n "${file_time}" && "${file_time}" -lt "${boot_time}" ]]; then
      return 1
    fi
  fi
  mode="$(read_state_mode)" || return 1
  printf '%s' "${mode}"
}

write_state_mode() {
  local mode="$1"
  local file=""
  local dir=""
  file="$(state_file)" || return 1
  dir="${file%/*}"
  mkdir -p "${dir}"
  printf '%s\n' "${mode}" > "${file}"
}

list_modes_from_file() {
  local file=""
  local line=""
  file="$(mode_file)" || return 1
  MODE_FILE_PATH="${file}"
  [[ -f "${file}" ]] || return 1
  while IFS= read -r line || [[ -n "${line}" ]]; do
    line="${line%%#*}"
    line="${line//[[:space:]]/}"
    [[ -z "${line}" ]] && continue
    normalize_mode "${line}"
    printf '\n'
  done < "${file}"
}

list_modes_from_env() {
  local modes="${NOCTALIA_GPU_MODES:-}"
  local mode=""
  [[ -z "${modes}" ]] && return 1
  for mode in ${modes}; do
    [[ -z "${mode}" ]] && continue
    normalize_mode "${mode}"
    printf '\n'
  done
}

mode_from_path() {
  local path="$1"
  local mode=""
  if [[ -n "${path}" ]]; then
    if [[ "${path}" == */specialisation/* ]]; then
      mode="${path##*/specialisation/}"
      mode="${mode%%/*}"
    elif [[ "${path}" == *"specialisation-"* ]]; then
      mode="${path##*specialisation-}"
      mode="${mode%%/*}"
    fi
  fi
  if [[ -n "${mode}" ]]; then
    printf '%s' "${mode}"
    return 0
  fi
  return 1
}

current_mode() {
  local path=""
  local mode=""

  path="$(readlink -f /run/current-system 2>/dev/null || true)"
  mode="$(mode_from_path "${path}" 2>/dev/null || true)"
  if [[ -n "${mode}" ]]; then
    printf '%s' "${mode}"
    return 0
  fi

  path="$(readlink -f /run/booted-system 2>/dev/null || true)"
  mode="$(mode_from_path "${path}" 2>/dev/null || true)"
  if [[ -n "${mode}" ]]; then
    printf '%s' "${mode}"
    return 0
  fi

  if [[ -r /proc/cmdline ]]; then
    local token=""
    local cmd_path=""
    local cmdline=""
    cmdline="$(</proc/cmdline)"
    for token in ${cmdline}; do
      case "${token}" in
        init=*)
          cmd_path="${token#init=}"
          ;;
        systemConfig=*)
          cmd_path="${token#systemConfig=}"
          ;;
        *)
          cmd_path=""
          ;;
      esac
      if [[ -n "${cmd_path}" ]]; then
        mode="$(mode_from_path "${cmd_path}" 2>/dev/null || true)"
        if [[ -n "${mode}" ]]; then
          printf '%s' "${mode}"
          return 0
        fi
      fi
    done
  fi

  mode="$(read_state_mode_fresh 2>/dev/null || true)"
  if [[ -n "${mode}" ]]; then
    printf '%s' "${mode}"
    return 0
  fi

  printf '%s' "base"
}

emit_status() {
  local mode=""
  local label=""
  mode="$(current_mode)"
  label="${mode}"
  if [[ "${label}" == gpu-* ]]; then
    label="${label#gpu-}"
  fi
  printf '{"text":"GPU:%s","tooltip":"GPU specialisation: %s"}\n' "${label}" "${mode}"
}

list_modes() {
  local modes=()
  local fallback=()
  if [[ -d "${MODE_DIR}" ]]; then
    while IFS= read -r -d '' entry; do
      local name=""
      name="$(basename "${entry}")"
      [[ "${name}" == gpu-* ]] || continue
      modes+=("${name}")
    done < <(find -L "${MODE_DIR}" -maxdepth 1 -mindepth 1 -type d -print0 2>/dev/null)
  fi

  if (( ${#modes[@]} > 0 )); then
    printf '%s\n' "${modes[@]}"
    return 0
  fi

  mapfile -t fallback < <(list_modes_from_file)
  if (( ${#fallback[@]} > 0 )); then
    printf '%s\n' "${fallback[@]}"
    return 0
  fi

  mapfile -t fallback < <(list_modes_from_env)
  if (( ${#fallback[@]} > 0 )); then
    printf '%s\n' "${fallback[@]}"
  fi
}

pick_menu() {
  if command -v fuzzel >/dev/null 2>&1; then
    fuzzel --dmenu --prompt "GPU mode: "
  elif command -v wofi >/dev/null 2>&1; then
    wofi --dmenu -p "GPU mode"
  elif command -v rofi >/dev/null 2>&1; then
    rofi -dmenu -p "GPU mode"
  else
    return 2
  fi
}

build_rebuild_cmd() {
  local specialisation="$1"
  local switch_path=""
  if [[ -n "${specialisation}" ]]; then
    switch_path="/nix/var/nix/profiles/system/specialisation/${specialisation}/bin/switch-to-configuration"
  else
    switch_path="/nix/var/nix/profiles/system/bin/switch-to-configuration"
  fi

  if [[ -x "${switch_path}" ]]; then
    printf '%s\n' "sudo" "${switch_path}" "switch"
    return 0
  fi
  if [[ -n "${specialisation}" ]]; then
    switch_path="/run/current-system/specialisation/${specialisation}/bin/switch-to-configuration"
  else
    switch_path="/run/current-system/bin/switch-to-configuration"
  fi
  if [[ -x "${switch_path}" ]]; then
    printf '%s\n' "sudo" "${switch_path}" "switch"
    return 0
  fi

  local cmd=(sudo nixos-rebuild switch)
  if [[ -n "${specialisation}" ]]; then
    cmd+=(--specialisation "${specialisation}")
  fi

  local flake="${NOCTALIA_FLAKE:-}"
  local home_dir="${HOME:-}"
  if [[ -z "${flake}" ]]; then
    local host_name=""
    if [[ -f /etc/hostname ]]; then
      host_name="$(tr -d '\n' </etc/hostname)"
    elif command -v hostname >/dev/null 2>&1; then
      host_name="$(hostname)"
    fi

    if [[ -f /etc/nixos/flake.nix ]]; then
      if [[ -n "${host_name}" ]]; then
        flake="/etc/nixos#${host_name}"
      else
        flake="/etc/nixos"
      fi
    elif [[ -n "${home_dir}" && -f "${home_dir}/nixos-config/flake.nix" ]]; then
      if [[ -n "${host_name}" ]]; then
        flake="${home_dir}/nixos-config#${host_name}"
      else
        flake="${home_dir}/nixos-config"
      fi
    fi
  fi

  if [[ -n "${flake}" ]]; then
    cmd+=(--flake "${flake}")
  fi

  printf '%s\n' "${cmd[@]}"
}

launch_in_terminal() {
  local term=""
  local cmd=()
  term="${TERMINAL:-}"
  if [[ -z "${term}" ]]; then
    for candidate in alacritty foot kitty wezterm; do
      if command -v "${candidate}" >/dev/null 2>&1; then
        term="${candidate}"
        break
      fi
    done
  fi

  if [[ -z "${term}" ]]; then
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "GPU specialisation" "No terminal found to run nixos-rebuild"
    fi
    return 1
  fi

  cmd=("$@")
  if command -v niri-run >/dev/null 2>&1; then
    case "${term}" in
      wezterm)
        exec niri-run wezterm start -- "${cmd[@]}"
        ;;
      *)
        exec niri-run "${term}" -e "${cmd[@]}"
        ;;
    esac
  else
    case "${term}" in
      wezterm)
        exec wezterm start -- "${cmd[@]}"
        ;;
      *)
        exec "${term}" -e "${cmd[@]}"
        ;;
    esac
  fi
}

apply_mode() {
  local target="$1"
  local specialisation=""
  local store_mode=""
  if [[ -z "${target}" || "${target}" == "base" ]]; then
    specialisation=""
    store_mode="base"
  else
    specialisation="$(normalize_mode "${target}")"
    store_mode="${specialisation}"
  fi
  mapfile -t rebuild_cmd < <(build_rebuild_cmd "${specialisation}")
  printf 'Running: %s\n' "${rebuild_cmd[*]}"
  if "${rebuild_cmd[@]}"; then
    write_state_mode "${store_mode}" || true
  else
    return $?
  fi
}

menu_flow() {
  local modes=()
  local labels=("base")
  local -A label_to_mode=()
  local mode=""
  local label=""
  local selection=""
  local target=""
  local menu_status=0

  mapfile -t modes < <(list_modes)
  if (( ${#modes[@]} == 0 )); then
    if command -v notify-send >/dev/null 2>&1; then
      local hint=""
      hint="No GPU specialisations found."
      if [[ -n "${MODE_FILE_PATH}" ]]; then
        hint="${hint} Provide modes via ${MODE_FILE_PATH} or NOCTALIA_GPU_MODES."
      fi
      notify-send "GPU specialisation" "${hint}"
    fi
    exit 0
  fi
  for mode in "${modes[@]}"; do
    label="${mode#gpu-}"
    labels+=("${label}")
    label_to_mode["${label}"]="${mode}"
  done

  selection="$(printf '%s\n' "${labels[@]}" | pick_menu)"
  menu_status=$?
  if [[ "${menu_status}" -ne 0 ]]; then
    if [[ "${menu_status}" -eq 2 ]]; then
      # No GUI menu available; fall back to terminal selection
      local cmd_path=""
      cmd_path="$(command -v noctalia-gpu-mode || true)"
      if [[ -z "${cmd_path}" ]]; then
        cmd_path="$0"
      fi
      launch_in_terminal bash -lc "${cmd_path} --menu-cli"
    fi
    exit 0
  fi

  if [[ -z "${selection}" || "${selection}" == "cancel" ]]; then
    exit 0
  fi

  if [[ "${selection}" == "base" ]]; then
    target=""
  else
    target="${label_to_mode[${selection}]:-}"
    if [[ -z "${target}" ]]; then
      exit 0
    fi
  fi

  local cmd_path=""
  cmd_path="$(command -v noctalia-gpu-mode || true)"
  if [[ -z "${cmd_path}" ]]; then
    cmd_path="$0"
  fi
  if [[ -z "${target}" ]]; then
    launch_in_terminal "${cmd_path}" --apply "base"
  else
    launch_in_terminal "${cmd_path}" --apply "${target}"
  fi
}

menu_flow_cli() {
  local modes=()
  local labels=("base")
  local -A label_to_mode=()
  local mode=""
  local label=""
  local selection=""
  local target=""

  mapfile -t modes < <(list_modes)
  if (( ${#modes[@]} == 0 )); then
    local hint=""
    hint="No GPU specialisations found."
    if [[ -n "${MODE_FILE_PATH}" ]]; then
      hint="${hint} Provide modes via ${MODE_FILE_PATH} or NOCTALIA_GPU_MODES."
    fi
    printf '%s\n' "${hint}"
    exit 0
  fi
  for mode in "${modes[@]}"; do
    label="${mode#gpu-}"
    labels+=("${label}")
    label_to_mode["${label}"]="${mode}"
  done

  printf '%s\n' "Select GPU mode:"
  PS3="GPU mode: "
  select selection in "${labels[@]}"; do
    if [[ -n "${selection}" ]]; then
      break
    fi
  done

  if [[ -z "${selection}" || "${selection}" == "cancel" ]]; then
    exit 0
  fi

  if [[ "${selection}" == "base" ]]; then
    target=""
  else
    target="${label_to_mode[${selection}]:-}"
    if [[ -z "${target}" ]]; then
      exit 0
    fi
  fi

  if [[ -z "${target}" ]]; then
    apply_mode "base"
  else
    apply_mode "${target}"
  fi
}

case "${1:-}" in
  --menu)
    menu_flow
    ;;
  --menu-cli)
    menu_flow_cli
    ;;
  --apply)
    apply_mode "${2:-}"
    ;;
  --set-state)
    if [[ -n "${2:-}" ]]; then
      if [[ "${2}" == "base" ]]; then
        write_state_mode "base" || true
      else
        write_state_mode "$(normalize_mode "${2}")" || true
      fi
    fi
    ;;
  *)
    emit_status
    ;;
esac
