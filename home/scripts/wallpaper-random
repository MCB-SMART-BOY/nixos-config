#!/usr/bin/env bash
# Random wallpaper setter for swaybg.

set -euo pipefail

# Ensure common NixOS paths are available when launched by the compositor.
export PATH="/run/current-system/sw/bin:/etc/profiles/per-user/${USER}/bin:${HOME}/.nix-profile/bin:${PATH}"

if [[ -z "${WAYLAND_DISPLAY:-}" ]]; then
  exit 0
fi

# Wallpaper directory managed by Home Manager.
wallpaper_dir="${HOME}/Pictures/Wallpapers"
fallback_dir="/etc/nixos/home/assets/wallpapers"

if [[ ! -d "${wallpaper_dir}" && -d "${fallback_dir}" ]]; then
  wallpaper_dir="${fallback_dir}"
fi

if [[ ! -d "${wallpaper_dir}" ]]; then
  exit 0
fi

# Collect supported image files.
mapfile -d '' wallpapers < <(
  find "${wallpaper_dir}" -maxdepth 1 -type f \
    \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' \) -print0
)

if [[ ${#wallpapers[@]} -eq 0 ]]; then
  exit 0
fi

# Pick a random wallpaper.
choice="${wallpapers[RANDOM % ${#wallpapers[@]}]}"

# Keep a stable lockscreen image path.
cache_dir="${HOME}/.cache"
lock_image="${cache_dir}/wallpaper-lock.png"
current_image="${cache_dir}/wallpaper-current"

mkdir -p "${cache_dir}"
ln -sf "${choice}" "${lock_image}"
ln -sf "${choice}" "${current_image}"

# Restart swaybg to apply the new wallpaper.
if command -v pkill >/dev/null 2>&1; then
  pkill swaybg >/dev/null 2>&1 || true
fi

swaybg_bin="$(command -v swaybg || true)"
if [[ -z "${swaybg_bin}" ]]; then
  exit 0
fi

exec "${swaybg_bin}" -i "${choice}" -m fill
